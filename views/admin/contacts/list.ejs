<div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <!-- Header -->
    <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-white">
        <div class="flex items-center gap-3">
            <h2 class="text-xl font-bold text-gray-800">Messages</h2>
            <span class="bg-blue-100 text-blue-600 text-xs font-semibold px-2.5 py-1 rounded-full"><%= contacts.length %></span>
        </div>
        <div class="flex items-center gap-3">
            <!-- Search -->
            <div class="relative">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
                <input type="text" id="searchMessages" placeholder="Search messages..." class="pl-10 pr-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent w-64">
            </div>
            <!-- Filter Dropdown -->
            <select id="filterMessages" class="px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="all">All</option>
                <option value="unread">Unread</option>
                <option value="read">Read</option>
            </select>
        </div>
    </div>
    
    <!-- Messages List -->
    <div class="divide-y divide-gray-100">
        <% if(contacts.length > 0) { %>
            <% contacts.forEach((contact, index) => { 
                // Generate avatar color based on name
                const colors = ['bg-purple-100 text-purple-600', 'bg-green-100 text-green-600', 'bg-blue-100 text-blue-600', 'bg-pink-100 text-pink-600', 'bg-yellow-100 text-yellow-600'];
                const avatarColor = colors[index % colors.length];
                const initial = contact.name.charAt(0).toUpperCase();
                const isUnread = index === 2; // Example: third message is unread
            %>
                <div class="message-item p-4 hover:bg-gray-50 hover:shadow-sm transition-all cursor-pointer relative <%= isUnread ? 'bg-blue-50/30' : '' %>" 
                     data-name="<%= contact.name.toLowerCase() %>" 
                     data-email="<%= contact.email.toLowerCase() %>" 
                     data-message="<%= contact.message.toLowerCase() %>" 
                     data-read="<%= !isUnread %>"
                     data-contact-id="<%= contact._id %>"
                     data-contact-name="<%= contact.name %>"
                     data-contact-email="<%= contact.email %>"
                     data-contact-message="<%= contact.message %>"
                     data-contact-date="<%= contact.createdAt %>">
                    <!-- Unread indicator -->
                    <% if(isUnread) { %>
                        <div class="absolute left-0 top-1/2 -translate-y-1/2 w-2 h-2 bg-red-500 rounded-full unread-dot"></div>
                    <% } %>
                    
                    <div class="flex items-start gap-4 ml-4">
                        <!-- Avatar -->
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 rounded-full <%= avatarColor %> flex items-center justify-center font-semibold text-lg">
                                <%= initial %>
                            </div>
                        </div>
                        
                        <!-- Content -->
                        <div class="flex-1 min-w-0">
                            <div class="flex items-start justify-between gap-4 mb-1">
                                <div>
                                    <h3 class="font-semibold text-gray-900 text-sm"><%= contact.name %></h3>
                                    <p class="text-xs text-gray-500"><%= contact.email %></p>
                                </div>
                                <span class="text-xs text-gray-400 flex-shrink-0">
                                    <% 
                                        const date = new Date(contact.createdAt);
                                        const today = new Date();
                                        const yesterday = new Date(today);
                                        yesterday.setDate(yesterday.getDate() - 1);
                                        
                                        if(date.toDateString() === today.toDateString()) {
                                    %>
                                        Today
                                    <% } else if(date.toDateString() === yesterday.toDateString()) { %>
                                        Yesterday
                                    <% } else { %>
                                        <%= date.toLocaleDateString() %>
                                    <% } %>
                                </span>
                            </div>
                            <div class="flex items-start justify-between gap-4">
                                <div class="flex-1">
                                    <p class="text-sm text-gray-900 font-medium mb-1 truncate">
                                        <%= contact.message.split('\n')[0].substring(0, 50) %>
                                    </p>
                                    <p class="text-sm text-gray-500 truncate">
                                        <%= contact.message.length > 80 ? contact.message.substring(0, 80) + '...' : contact.message %>
                                    </p>
                                </div>
                                <!-- Actions (visible on hover) -->
                                <div class="flex items-center gap-2 opacity-0 message-actions transition-opacity">
                                    <button onclick="openMessageModal(this)" class="text-blue-500 hover:text-blue-700 p-2 rounded-md hover:bg-blue-50 transition-colors" title="View message">
                                        <i class="fas fa-eye text-sm"></i>
                                    </button>
                                    <form action="/admin/contacts/<%= contact._id %>/delete" method="POST" class="inline">
                                        <button type="button" onclick="openDeleteModal(this.closest('form'))" class="text-red-400 hover:text-red-600 p-2 rounded-md hover:bg-red-50 transition-colors" title="Delete">
                                            <i class="fas fa-trash-alt text-sm"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            <% }) %>
        <% } else { %>
            <div class="p-12 text-center text-gray-500">
                <i class="fas fa-inbox text-4xl mb-3 text-gray-300"></i>
                <p class="text-lg font-medium mb-1">No messages yet</p>
                <p class="text-sm">When someone contacts you, they'll appear here.</p>
            </div>
        <% } %>
    </div>
</div>

<!-- Message Detail Modal -->
<div id="messageModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" onclick="closeMessageModal(event)">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
        <!-- Modal Header -->
        <div class="p-6 border-b border-gray-100">
            <div class="flex items-start gap-4">
                <button onclick="closeMessageModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                        <div id="modalAvatar" class="w-12 h-12 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center font-semibold text-lg">
                            T
                        </div>
                        <div>
                            <h3 id="modalName" class="font-bold text-gray-900 text-lg">Taaha Haider</h3>
                            <p id="modalEmail" class="text-sm text-gray-500">admin@gmail.com</p>
                        </div>
                    </div>
                </div>
                <div class="text-right">
                    <p id="modalDate" class="text-xs text-gray-400">November 24, 2025</p>
                    <p id="modalTime" class="text-xs text-gray-400">10:33 PM</p>
                </div>
            </div>
        </div>
        
        <!-- Modal Body -->
        <div class="p-6 overflow-y-auto max-h-[50vh]">
            <div class="mb-4">
                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Subject</p>
                <h4 id="modalSubject" class="text-lg font-bold text-gray-900">Want to earn more money</h4>
            </div>
            
            <div class="border-t border-gray-200 pt-4">
                <p id="modalMessage" class="text-gray-700 whitespace-pre-wrap leading-relaxed">
                    Hi Aftab,

I saw your portfolio and really liked your full-stack projects.
Are you available for freelance work?

Looking forward to your reply!

Best,
Taaha Haider
                </p>
            </div>
        </div>
        
        <!-- Modal Footer -->
        <div class="p-6 border-t border-gray-100 bg-gray-50 flex items-center justify-between gap-3">
            <button id="replyButton" onclick="replyToMessage()" class="bg-blue-600 text-white px-6 py-2.5 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2 font-medium">
                <i class="fas fa-reply"></i>
                Reply via Email
            </button>
            <div class="flex items-center gap-2">
                <button id="markReadButton" onclick="markAsReadFromModal()" class="text-gray-600 hover:text-gray-800 px-4 py-2.5 rounded-lg hover:bg-gray-100 transition-colors flex items-center gap-2">
                    <i class="fas fa-check"></i>
                    Mark as Read
                </button>
                <button id="deleteButton" onclick="deleteFromModal()" class="text-red-600 hover:text-red-700 px-4 py-2.5 rounded-lg hover:bg-red-50 transition-colors flex items-center gap-2">
                    <i class="fas fa-trash-alt"></i>
                    Delete
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.message-item:hover .message-actions {
    opacity: 1;
}
</style>

<script>
let currentMessageItem = null;

// Search functionality
document.getElementById('searchMessages')?.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const messages = document.querySelectorAll('.message-item');
    
    messages.forEach(message => {
        const name = message.dataset.name;
        const email = message.dataset.email;
        const messageText = message.dataset.message;
        
        if(name.includes(searchTerm) || email.includes(searchTerm) || messageText.includes(searchTerm)) {
            message.style.display = '';
        } else {
            message.style.display = 'none';
        }
    });
});

// Filter functionality
document.getElementById('filterMessages')?.addEventListener('change', function(e) {
    const filter = e.target.value;
    const messages = document.querySelectorAll('.message-item');
    
    messages.forEach(message => {
        const isRead = message.dataset.read === 'true';
        
        if(filter === 'all') {
            message.style.display = '';
        } else if(filter === 'unread' && !isRead) {
            message.style.display = '';
        } else if(filter === 'read' && isRead) {
            message.style.display = '';
        } else {
            message.style.display = 'none';
        }
    });
});

// Open message modal
function openMessageModal(button) {
    const messageItem = button.closest('.message-item');
    currentMessageItem = messageItem;
    
    const name = messageItem.dataset.contactName;
    const email = messageItem.dataset.contactEmail;
    const message = messageItem.dataset.contactMessage;
    const dateStr = messageItem.dataset.contactDate;
    const contactId = messageItem.dataset.contactId;
    
    // Get avatar info
    const avatarDiv = messageItem.querySelector('.w-12.h-12');
    const avatarClasses = avatarDiv.className;
    const initial = avatarDiv.textContent.trim();
    
    // Update modal content
    document.getElementById('modalAvatar').className = avatarDiv.className;
    document.getElementById('modalAvatar').textContent = initial;
    document.getElementById('modalName').textContent = name;
    document.getElementById('modalEmail').textContent = email;
    
    // Format date
    const date = new Date(dateStr);
    const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
    const timeOptions = { hour: '2-digit', minute: '2-digit' };
    document.getElementById('modalDate').textContent = date.toLocaleDateString('en-US', dateOptions);
    document.getElementById('modalTime').textContent = date.toLocaleTimeString('en-US', timeOptions);
    
    // Set subject (first line of message)
    const subject = message.split('\n')[0];
    document.getElementById('modalSubject').textContent = subject;
    document.getElementById('modalMessage').textContent = message;
    
    // Store contact ID for actions
    document.getElementById('replyButton').dataset.email = email;
    document.getElementById('deleteButton').dataset.contactId = contactId;
    
    // Show modal
    const modal = document.getElementById('messageModal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    
    // Mark as read automatically
    markMessageAsRead(messageItem);
}

// Close message modal
function closeMessageModal(event) {
    if(event && event.target !== event.currentTarget) return;
    const modal = document.getElementById('messageModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    currentMessageItem = null;
}

// Mark message as read
function markMessageAsRead(messageItem) {
    messageItem.dataset.read = 'true';
    messageItem.classList.remove('bg-blue-50/30');
    const indicator = messageItem.querySelector('.unread-dot');
    if(indicator) indicator.remove();
}

// Mark as read from modal
function markAsReadFromModal() {
    if(currentMessageItem) {
        markMessageAsRead(currentMessageItem);
    }
    closeMessageModal();
}

// Reply to message
function replyToMessage() {
    const email = document.getElementById('replyButton').dataset.email;
    const subject = document.getElementById('modalSubject').textContent;
    window.location.href = `mailto:${email}?subject=Re: ${encodeURIComponent(subject)}`;
}

// Delete from modal
function deleteFromModal() {
    const contactId = document.getElementById('deleteButton').dataset.contactId;
    const form = document.querySelector(`form[action="/admin/contacts/${contactId}/delete"]`);
    if(form) {
        closeMessageModal();
        openDeleteModal(form);
    }
}

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if(e.key === 'Escape') {
        closeMessageModal();
    }
});
</script>
