<div class="max-w-3xl mx-auto pb-24">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-4">
            <a href="/admin/finance/people" class="w-10 h-10 flex items-center justify-center rounded-full bg-white border border-gray-200 text-gray-600 hover:bg-gray-50 transition-colors shadow-sm">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h1 class="text-2xl font-bold text-gray-900">Back to People</h1>
        </div>
        <a href="/admin/finance/people/edit/<%= person._id %>" class="px-4 py-2 bg-white border border-gray-200 text-gray-700 rounded-lg hover:bg-gray-50 text-sm font-medium transition-colors shadow-sm">
            <i class="fas fa-edit mr-2"></i> Edit
        </a>
    </div>

    <!-- Person Info Card -->
    <div class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100 mb-6 relative overflow-hidden">
        <div class="flex flex-col md:flex-row gap-6 items-start md:items-center relative z-10">
            <!-- Avatar -->
            <div class="w-20 h-20 rounded-full bg-gradient-to-br from-blue-100 to-blue-50 flex items-center justify-center text-3xl font-bold text-blue-600 shadow-inner border-4 border-white">
                <%= person.name.charAt(0).toUpperCase() %>
            </div>
            
            <!-- Info -->
            <div class="flex-1 w-full">
                <div class="flex justify-between items-start">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900 leading-tight"><%= person.name %></h2>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="px-2.5 py-0.5 rounded-full text-xs font-bold bg-gray-100 text-gray-600 uppercase tracking-wide">
                                <%= person.type %>
                            </span>
                            <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                            <span class="text-xs text-gray-400 font-medium">Active</span>
                        </div>
                    </div>
                    
                    <!-- Quick Actions (Top Right of Card) -->
                    <div class="flex gap-2">
                        <button class="w-10 h-10 rounded-full bg-gray-50 text-gray-400 hover:text-yellow-400 hover:bg-yellow-50 transition-colors flex items-center justify-center">
                            <i class="fas fa-star"></i>
                        </button>
                        <% if(person.phone) { %>
                            <a href="tel:<%= person.phone %>" class="w-10 h-10 rounded-full bg-green-50 text-green-600 hover:bg-green-100 transition-colors flex items-center justify-center">
                                <i class="fas fa-phone"></i>
                            </a>
                            <a href="https://wa.me/<%= person.phone.replace(/[^0-9]/g, '') %>" target="_blank" class="w-10 h-10 rounded-full bg-green-50 text-green-600 hover:bg-green-100 transition-colors flex items-center justify-center">
                                <i class="fab fa-whatsapp text-lg"></i>
                            </a>
                        <% } %>
                    </div>
                </div>
                
                <div class="mt-4 space-y-1">
                    <% if(person.phone) { %>
                        <div class="flex items-center text-gray-500 text-sm font-medium">
                            <i class="fas fa-phone-alt w-5 text-center mr-2 text-gray-300"></i>
                            <%= person.phone %>
                        </div>
                    <% } %>
                    <% if(person.email) { %>
                        <div class="flex items-center text-gray-500 text-sm font-medium">
                            <i class="fas fa-envelope w-5 text-center mr-2 text-gray-300"></i>
                            <%= person.email %>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- Add Note Button (if no notes) or Display Note -->
        <div class="mt-6 pt-6 border-t border-gray-100">
            <% if(person.notes) { %>
                <div class="bg-yellow-50/50 p-4 rounded-xl border border-yellow-100 text-sm text-gray-700 flex gap-3">
                    <i class="fas fa-sticky-note text-yellow-400 mt-0.5"></i>
                    <p><%= person.notes %></p>
                </div>
            <% } else { %>
                <a href="/admin/finance/people/edit/<%= person._id %>" class="text-sm text-blue-600 font-bold hover:text-blue-700 flex items-center transition-colors">
                    <i class="fas fa-plus-circle mr-2"></i> Add Note
                </a>
            <% } %>
        </div>
    </div>

    <!-- Net Balance Card -->
    <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100 mb-6 text-center relative overflow-hidden">
        <div class="relative z-10">
            <p class="text-xs text-gray-400 font-bold uppercase tracking-widest mb-3">Net Balance</p>
            
            <% 
                const balance = stats.balance; 
                // balance < 0: They owe me (Receivable) -> Green
                // balance > 0: I owe them (Payable) -> Red
                // balance == 0: Settled
            %>

            <% if (balance === 0) { %>
                <h2 class="text-4xl font-black text-gray-800 mb-2 tracking-tight">Rs 0 · Settled</h2>
                <p class="text-green-500 font-medium text-sm flex items-center justify-center gap-2">
                    <i class="fas fa-check-circle"></i> All clear!
                </p>
                <div class="w-full h-3 bg-gray-100 rounded-full mt-8 overflow-hidden">
                    <div class="h-full bg-green-500 w-full"></div>
                </div>
            <% } else if (balance < 0) { %>
                <h2 class="text-4xl font-black text-green-600 mb-2 tracking-tight">Owes You Rs <%= Math.abs(balance).toLocaleString() %></h2>
                <p class="text-gray-400 text-sm">You are owed money</p>
                <div class="w-full h-3 bg-gray-100 rounded-full mt-8 overflow-hidden">
                    <div class="h-full bg-green-500 w-full animate-pulse"></div>
                </div>
            <% } else { %>
                <h2 class="text-4xl font-black text-red-600 mb-2 tracking-tight">You Owe Rs <%= Math.abs(balance).toLocaleString() %></h2>
                <p class="text-gray-400 text-sm">Payment pending</p>
                <div class="w-full h-3 bg-gray-100 rounded-full mt-8 overflow-hidden">
                    <div class="h-full bg-red-500 w-full animate-pulse"></div>
                </div>
            <% } %>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-2 gap-4 mb-6">
        <div class="bg-red-50 rounded-3xl p-6 border border-red-100 relative overflow-hidden group">
            <div class="absolute right-0 top-0 p-4 opacity-10 transform translate-x-2 -translate-y-2 group-hover:scale-110 transition-transform">
                <i class="fas fa-arrow-up text-6xl text-red-600"></i>
            </div>
            <p class="text-[10px] md:text-xs text-red-600 font-bold uppercase tracking-wider mb-2">Total Given</p>
            <p class="text-xs text-red-400 mb-1">You &rarr; <%= person.name.split(' ')[0] %></p>
            <p class="text-2xl md:text-3xl font-black text-gray-900">Rs <%= stats.totalGiven.toLocaleString() %></p>
            
            <div class="mt-4 flex items-center text-xs font-bold text-red-600 bg-red-100/50 w-fit px-2 py-1 rounded-lg">
                <i class="fas fa-arrow-up mr-1.5"></i> Red card
            </div>
        </div>
        <div class="bg-green-50 rounded-3xl p-6 border border-green-100 relative overflow-hidden group">
            <div class="absolute right-0 top-0 p-4 opacity-10 transform translate-x-2 -translate-y-2 group-hover:scale-110 transition-transform">
                <i class="fas fa-arrow-down text-6xl text-green-600"></i>
            </div>
            <p class="text-[10px] md:text-xs text-green-600 font-bold uppercase tracking-wider mb-2">Total Received</p>
            <p class="text-xs text-green-400 mb-1"><%= person.name.split(' ')[0] %> &rarr; You</p>
            <p class="text-2xl md:text-3xl font-black text-gray-900">Rs <%= stats.totalReceived.toLocaleString() %></p>
            
            <div class="mt-4 flex items-center text-xs font-bold text-green-600 bg-green-100/50 w-fit px-2 py-1 rounded-lg">
                <i class="fas fa-arrow-down mr-1.5"></i> Green card
            </div>
        </div>
    </div>

    <!-- Balance Trend -->
    <div class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100 mb-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg font-bold text-gray-900">Balance Trend</h3>
            <span class="text-xs font-medium text-gray-400 bg-gray-50 px-2 py-1 rounded-lg">Last 6 Months</span>
        </div>
        <div class="h-64 w-full">
            <canvas id="balanceChart"></canvas>
        </div>
    </div>

    <!-- Key Stats -->
    <% 
        const totalTx = payments.length;
        const avgTx = totalTx > 0 ? Math.round((stats.totalGiven + stats.totalReceived) / totalTx) : 0;
        const firstTx = totalTx > 0 ? new Date(payments[payments.length - 1].date).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'}) : '-';
        const lastTx = totalTx > 0 ? new Date(payments[0].date).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'}) : '-';
    %>
    <div class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100 mb-8">
        <h3 class="text-lg font-bold text-gray-900 mb-6">Key Stats</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-y-6 gap-x-4">
            <div class="flex flex-col">
                <span class="text-xs text-gray-400 font-medium mb-1">First transaction</span>
                <span class="font-bold text-gray-900"><%= firstTx %></span>
            </div>
            <div class="flex flex-col">
                <span class="text-xs text-gray-400 font-medium mb-1">Last transaction</span>
                <span class="font-bold text-gray-900"><%= lastTx %></span>
            </div>
            <div class="flex flex-col">
                <span class="text-xs text-gray-400 font-medium mb-1">Total transactions</span>
                <span class="font-bold text-gray-900"><%= totalTx %></span>
            </div>
            <div class="flex flex-col">
                <span class="text-xs text-gray-400 font-medium mb-1">Average transaction</span>
                <span class="font-bold text-gray-900">Rs <%= avgTx.toLocaleString() %></span>
            </div>
        </div>
    </div>

    <!-- Transaction History -->
    <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100 mb-24">
        <h3 class="text-lg font-bold text-gray-900 mb-8">Transaction History</h3>
        
        <% if (payments.length === 0) { %>
            <div class="text-center py-12">
                <div class="w-24 h-24 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-receipt text-3xl text-gray-300"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-900 mb-2">No transactions yet</h3>
                <p class="text-gray-500 text-sm">Start by recording a payment!</p>
            </div>
        <% } else { %>
            <div class="relative border-l-2 border-gray-100 ml-3 space-y-10 pb-2">
                <% payments.forEach(p => { %>
                    <div class="relative pl-8">
                        <!-- Dot -->
                        <div class="absolute -left-[9px] top-1.5 w-4 h-4 rounded-full border-2 border-white shadow-sm <%= p.type === 'send' ? 'bg-red-500' : 'bg-green-500' %> ring-4 ring-gray-50"></div>
                        
                        <div class="flex justify-between items-start group">
                            <div>
                                <p class="text-xs font-bold text-gray-400 uppercase mb-1 tracking-wide">
                                    <%= new Date(p.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %>
                                </p>
                                <h4 class="font-bold text-gray-900 text-base mb-1">
                                    <%= p.type === 'send' ? 'You gave to ' + person.name.split(' ')[0] : 'You received from ' + person.name.split(' ')[0] %>
                                </h4>
                                <% if(p.notes) { %>
                                    <p class="text-gray-500 text-sm italic bg-gray-50 px-2 py-1 rounded-lg inline-block">"<%= p.notes %>"</p>
                                <% } %>
                            </div>
                            <div class="text-right">
                                <p class="font-black text-lg <%= p.type === 'send' ? 'text-red-600' : 'text-green-600' %>">
                                    <%= p.type === 'send' ? '–' : '+' %> Rs <%= p.amount.toLocaleString() %>
                                </p>
                                <span class="inline-block px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide mt-1 <%= p.status === 'Completed' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700' %>">
                                    <%= p.status %>
                                </span>
                            </div>
                        </div>
                    </div>
                <% }) %>
            </div>
        <% } %>
    </div>

    <!-- Floating Action Buttons -->
    <div class="fixed bottom-8 right-8 flex gap-4 z-40">
        <button onclick="openPaymentModal('send')" class="h-16 px-8 bg-red-600 hover:bg-red-700 text-white rounded-full shadow-xl shadow-red-500/40 font-bold flex items-center transition-all hover:scale-105 active:scale-95 group">
            <span class="bg-red-500 p-2 rounded-full mr-3 group-hover:bg-red-400 transition-colors">
                <i class="fas fa-arrow-up text-sm"></i>
            </span>
            <span class="text-lg">Pay / Give</span>
        </button>
        <button onclick="openPaymentModal('receive')" class="h-16 px-8 bg-green-600 hover:bg-green-700 text-white rounded-full shadow-xl shadow-green-500/40 font-bold flex items-center transition-all hover:scale-105 active:scale-95 group">
            <span class="bg-green-500 p-2 rounded-full mr-3 group-hover:bg-green-400 transition-colors">
                <i class="fas fa-arrow-down text-sm"></i>
            </span>
            <span class="text-lg">Receive / Get</span>
        </button>
    </div>
</div>

<!-- Payment Modal (Reused & Styled) -->
<div id="paymentModal" class="fixed inset-0 z-50 hidden">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closePaymentModal()"></div>
    
    <!-- Modal Content -->
    <div class="absolute bottom-0 md:top-1/2 md:left-1/2 md:bottom-auto md:-translate-x-1/2 md:-translate-y-1/2 w-full md:w-[480px] bg-white md:rounded-3xl rounded-t-3xl shadow-2xl transform transition-transform duration-300 translate-y-full scale-95 opacity-0 max-h-[90vh] overflow-y-auto" id="modalContent">
        <div class="p-8">
            <div class="flex justify-between items-center mb-8">
                <h3 class="text-2xl font-bold text-gray-900" id="modalTitle">Record Payment</h3>
                <button onclick="closePaymentModal()" class="w-10 h-10 rounded-full bg-gray-50 text-gray-400 hover:text-gray-600 hover:bg-gray-100 transition-colors flex items-center justify-center">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>

            <form action="/admin/finance/payments/add" method="POST" class="space-y-6">
                <input type="hidden" name="person" value="<%= person._id %>">
                <input type="hidden" name="type" id="paymentTypeInput">
                <input type="hidden" name="status" value="Completed">
                
                <!-- Amount Display -->
                <div class="bg-gray-50 p-8 rounded-3xl text-center border border-gray-100 flex flex-col items-center justify-center group focus-within:border-blue-200 focus-within:bg-blue-50/30 transition-all">
                    <label class="text-xs text-gray-400 uppercase tracking-widest mb-2 font-bold">Amount</label>
                    <div class="relative flex items-center justify-center">
                        <span class="text-gray-400 text-3xl mr-2 font-medium">Rs</span>
                        <input type="number" name="amount" required min="1" placeholder="0" class="bg-transparent text-6xl font-black text-gray-900 w-48 text-center focus:outline-none placeholder-gray-200" autofocus>
                    </div>
                </div>

                <!-- Date & Wallet -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2 ml-1">Date</label>
                        <input type="date" name="date" value="<%= new Date().toISOString().split('T')[0] %>" class="w-full px-4 py-3.5 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm bg-gray-50/50 font-medium">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2 ml-1">Wallet</label>
                        <select name="wallet" class="w-full px-4 py-3.5 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm bg-gray-50/50 font-medium">
                            <option value="">None (Cash)</option>
                             <% if(locals.wallets) { %>
                                <% wallets.forEach(w => { %>
                                    <option value="<%= w._id %>"><%= w.name %></option>
                                <% }) %>
                             <% } %>
                        </select>
                    </div>
                </div>

                <!-- Notes -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2 ml-1">Note</label>
                    <input type="text" name="notes" placeholder="e.g. Dinner bill" class="w-full px-4 py-3.5 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm bg-gray-50/50 font-medium">
                </div>

                <!-- Submit -->
                <button type="submit" class="w-full py-4 rounded-2xl text-white font-bold text-lg shadow-xl transition-all active:scale-95 flex items-center justify-center gap-2 mt-6" id="submitBtn">
                    <i class="fas fa-check"></i>
                    <span>Confirm</span>
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    // Chart Logic
    const payments = <%- JSON.stringify(payments) %>;
    
    // Process payments to get daily balance trend
    // 1. Sort payments by date ASC
    const sortedPayments = [...payments].sort((a, b) => new Date(a.date) - new Date(b.date));

    // 2. Calculate running balance
    let runningBalance = 0;
    const balanceHistory = sortedPayments.map(p => {
        // If type is 'send' (I gave), balance decreases (becomes more negative / less positive)
        // If type is 'receive' (I got), balance increases (becomes more positive / less negative)
        // Wait, let's align with "Net Balance" logic:
        // Balance = Received - Given
        // Send: Given increases -> Balance decreases
        // Receive: Received increases -> Balance increases
        
        if (p.type === 'send') {
            runningBalance -= p.amount;
        } else {
            runningBalance += p.amount;
        }
        
        return {
            date: p.date,
            balance: runningBalance
        };
    });

    // 3. Filter for last 6 months (or just take last N points if sparse)
    // Let's just take the last 10-15 points to make the chart look good, or all if fewer.
    // Or filter by date.
    
    // Let's generate a daily series for the last 6 months? No, that's too much processing.
    // Let's just plot the transaction points.
    
    const ctx = document.getElementById('balanceChart').getContext('2d');
    
    // Prepare data
    // If no payments, show empty chart or 0 line
    const labels = balanceHistory.map(p => new Date(p.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
    // Invert balance for display? 
    // If Balance < 0 (They owe me), it should probably be shown as positive "Owed Amount"?
    // Or just show the raw balance.
    // Let's show raw balance. 
    // Positive = I owe them.
    // Negative = They owe me.
    const dataPoints = balanceHistory.map(p => p.balance);

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Net Balance (Positive = You Owe, Negative = Owes You)',
                data: dataPoints,
                borderColor: '#4F46E5', // Indigo 600
                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                borderWidth: 3,
                pointBackgroundColor: '#ffffff',
                pointBorderColor: '#4F46E5',
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += 'Rs ' + Math.abs(context.parsed.y).toLocaleString();
                                if (context.parsed.y < 0) label += ' (Owes You)';
                                else if (context.parsed.y > 0) label += ' (You Owe)';
                                else label += ' (Settled)';
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    grid: {
                        color: '#f3f4f6',
                        drawBorder: false,
                    },
                    ticks: {
                        callback: function(value) {
                            return 'Rs ' + Math.abs(value);
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    // Modal Logic
    function openPaymentModal(type) {
        const modal = document.getElementById('paymentModal');
        const content = document.getElementById('modalContent');
        const title = document.getElementById('modalTitle');
        const typeInput = document.getElementById('paymentTypeInput');
        const submitBtn = document.getElementById('submitBtn');

        modal.classList.remove('hidden');
        requestAnimationFrame(() => {
            content.classList.remove('translate-y-full', 'scale-95', 'opacity-0');
        });

        typeInput.value = type;
        if (type === 'send') {
            title.innerText = 'Record Payment (You Gave)';
            submitBtn.className = 'w-full py-4 rounded-2xl text-white font-bold text-lg shadow-xl transition-transform active:scale-95 flex items-center justify-center gap-2 bg-red-600 hover:bg-red-700 shadow-red-500/30';
        } else {
            title.innerText = 'Record Receipt (You Received)';
            submitBtn.className = 'w-full py-4 rounded-2xl text-white font-bold text-lg shadow-xl transition-transform active:scale-95 flex items-center justify-center gap-2 bg-green-600 hover:bg-green-700 shadow-green-500/30';
        }
    }

    function closePaymentModal() {
        const modal = document.getElementById('paymentModal');
        const content = document.getElementById('modalContent');

        content.classList.add('translate-y-full', 'scale-95', 'opacity-0');
        
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }
</script>
