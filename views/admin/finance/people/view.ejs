<div class="max-w-4xl mx-auto">
    <!-- Header / Back -->
    <div class="mb-6 flex items-center justify-between">
        <a href="/admin/finance/payments" class="flex items-center text-gray-500 hover:text-gray-800 transition-colors">
            <i class="fas fa-arrow-left mr-2"></i> Back to Payments
        </a>
        <div class="flex gap-2">
            <a href="/admin/finance/people/edit/<%= person._id %>" class="px-4 py-2 bg-white border border-gray-200 text-gray-700 rounded-lg hover:bg-gray-50 text-sm font-medium transition-colors">
                <i class="fas fa-edit mr-2"></i> Edit Profile
            </a>
        </div>
    </div>

    <!-- Main Card -->
    <div class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden relative">
        <!-- Background Blur/Decoration -->
        <div class="absolute top-0 right-0 w-64 h-64 bg-blue-50 rounded-full blur-3xl -mr-16 -mt-16 opacity-50 pointer-events-none"></div>
        <div class="absolute bottom-0 left-0 w-64 h-64 bg-purple-50 rounded-full blur-3xl -ml-16 -mb-16 opacity-50 pointer-events-none"></div>

        <div class="relative z-10 p-6 md:p-8">
            <!-- Person Header -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900"><%= person.name %></h1>
                    <div class="flex items-center gap-3 mt-2">
                        <span class="px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                            <%= person.type || 'Contact' %>
                        </span>
                        <% if(person.phone) { %>
                            <span class="text-gray-500 text-sm flex items-center">
                                <i class="fas fa-phone-alt mr-1 text-xs"></i> <%= person.phone %>
                            </span>
                        <% } %>
                        <% if(person.location) { %>
                            <span class="text-gray-500 text-sm flex items-center">
                                <i class="fas fa-map-marker-alt mr-1 text-xs"></i> <%= person.location %>
                            </span>
                        <% } %>
                    </div>
                </div>
                
                <!-- Net Balance Display -->
                <div class="text-right bg-gray-50 px-6 py-3 rounded-xl border border-gray-100">
                    <p class="text-xs text-gray-500 uppercase tracking-wider font-medium mb-1">Net Balance</p>
                    <% if (stats.balance > 0) { %>
                        <h2 class="text-2xl font-bold text-red-600">You owe Rs <%= Math.abs(stats.balance).toLocaleString() %></h2>
                    <% } else if (stats.balance < 0) { %>
                        <h2 class="text-2xl font-bold text-green-600">Owes you Rs <%= Math.abs(stats.balance).toLocaleString() %></h2>
                    <% } else { %>
                        <h2 class="text-2xl font-bold text-gray-600">Settled</h2>
                    <% } %>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="p-4 rounded-xl bg-red-50 border border-red-100">
                    <p class="text-xs text-red-600 font-medium uppercase mb-1">Total Given (Sent)</p>
                    <p class="text-xl font-bold text-gray-900">Rs <%= stats.totalGiven.toLocaleString() %></p>
                </div>
                <div class="p-4 rounded-xl bg-green-50 border border-green-100">
                    <p class="text-xs text-green-600 font-medium uppercase mb-1">Total Received</p>
                    <p class="text-xl font-bold text-gray-900">Rs <%= stats.totalReceived.toLocaleString() %></p>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-2 gap-4 mb-10">
                <button onclick="openPaymentModal('send')" class="flex items-center justify-center px-6 py-4 bg-red-600 text-white rounded-xl hover:bg-red-700 transition-all shadow-lg shadow-red-500/30 group">
                    <div class="flex flex-col items-center">
                        <i class="fas fa-arrow-up mb-1 text-lg group-hover:-translate-y-1 transition-transform"></i>
                        <span class="font-bold">Pay / Give</span>
                    </div>
                </button>
                <button onclick="openPaymentModal('receive')" class="flex items-center justify-center px-6 py-4 bg-green-600 text-white rounded-xl hover:bg-green-700 transition-all shadow-lg shadow-green-500/30 group">
                    <div class="flex flex-col items-center">
                        <i class="fas fa-arrow-down mb-1 text-lg group-hover:translate-y-1 transition-transform"></i>
                        <span class="font-bold">Receive / Get</span>
                    </div>
                </button>
            </div>

            <!-- Transaction History -->
            <div>
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-history mr-2 text-gray-400"></i> Transaction History
                </h3>
                <div class="space-y-3">
                    <% if (payments.length === 0) { %>
                        <div class="text-center py-8 text-gray-400 bg-gray-50 rounded-xl border border-dashed border-gray-200">
                            <p>No transactions yet</p>
                        </div>
                    <% } %>
                    
                    <% payments.forEach(p => { %>
                        <div class="flex items-center justify-between p-4 rounded-xl border border-gray-100 hover:border-blue-200 hover:shadow-sm transition-all bg-white group">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center <%= p.type === 'send' ? 'bg-red-50 text-red-600' : 'bg-green-50 text-green-600' %>">
                                    <i class="fas <%= p.type === 'send' ? 'fa-arrow-up' : 'fa-arrow-down' %>"></i>
                                </div>
                                <div>
                                    <p class="font-bold text-gray-900">
                                        <%= p.type === 'send' ? 'You gave' : 'You received' %>
                                    </p>
                                    <p class="text-xs text-gray-500">
                                        <%= new Date(p.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %>
                                        <% if(p.notes) { %> â€¢ <span class="italic"><%= p.notes %></span> <% } %>
                                    </p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-bold <%= p.type === 'send' ? 'text-red-600' : 'text-green-600' %>">
                                    Rs <%= p.amount.toLocaleString() %>
                                </p>
                                <span class="text-[10px] px-2 py-0.5 rounded-full <%= p.status === 'Completed' ? 'bg-green-100 text-green-700' : p.status === 'Partial' ? 'bg-blue-100 text-blue-700' : 'bg-yellow-100 text-yellow-700' %>">
                                    <%= p.status %>
                                </span>
                            </div>
                        </div>
                    <% }) %>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Partial Payment Modal Overlay -->
<div id="paymentModal" class="fixed inset-0 z-50 hidden">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closePaymentModal()"></div>
    
    <!-- Modal Content -->
    <div class="absolute bottom-0 md:top-1/2 md:left-1/2 md:bottom-auto md:-translate-x-1/2 md:-translate-y-1/2 w-full md:w-[480px] bg-white md:rounded-2xl rounded-t-2xl shadow-2xl transform transition-transform duration-300 translate-y-full scale-95 opacity-0 max-h-[90vh] overflow-y-auto" id="modalContent">
        <div class="p-6">
            <div class="flex justify-between items-center mb-6 sticky top-0 bg-white z-10 pb-2 border-b border-gray-50">
                <h3 class="text-xl font-bold text-gray-900" id="modalTitle">Record Payment</h3>
                <button onclick="closePaymentModal()" class="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <form action="/admin/finance/payments/add" method="POST" class="space-y-5 pb-2">
                <input type="hidden" name="person" value="<%= person._id %>">
                <input type="hidden" name="type" id="paymentTypeInput">
                <input type="hidden" name="status" value="Completed"> <!-- Default to completed for quick payments -->
                
                <!-- Amount Display -->
                <div class="bg-gray-50 p-6 rounded-2xl text-center border border-gray-100 flex flex-col items-center justify-center group focus-within:border-blue-200 focus-within:bg-blue-50/30 transition-all">
                    <label class="text-xs text-gray-500 uppercase tracking-wider mb-2 font-medium">Amount</label>
                    <div class="relative flex items-center justify-center">
                        <span class="text-gray-400 text-2xl mr-2 font-medium">Rs</span>
                        <input type="number" name="amount" required min="1" placeholder="0" class="bg-transparent text-5xl font-bold text-gray-900 w-48 text-center focus:outline-none placeholder-gray-300" autofocus>
                    </div>
                </div>

                <!-- Date & Wallet -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1.5 ml-1">Date</label>
                        <input type="date" name="date" value="<%= new Date().toISOString().split('T')[0] %>" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm bg-gray-50/50">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1.5 ml-1">Wallet</label>
                        <select name="wallet" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm bg-gray-50/50">
                            <option value="">None (Cash)</option>
                            <!-- Wallets should be passed from controller -->
                             <% if(locals.wallets) { %>
                                <% wallets.forEach(w => { %>
                                    <option value="<%= w._id %>"><%= w.name %></option>
                                <% }) %>
                             <% } %>
                        </select>
                    </div>
                </div>

                <!-- Notes -->
                <div>
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-1.5 ml-1">Note</label>
                    <input type="text" name="notes" placeholder="e.g. Monthly rent" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm bg-gray-50/50">
                </div>

                <!-- Submit -->
                <button type="submit" class="w-full py-4 rounded-xl text-white font-bold text-lg shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2 mt-4" id="submitBtn">
                    <i class="fas fa-check"></i>
                    <span>Confirm Payment</span>
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    function openPaymentModal(type) {
        const modal = document.getElementById('paymentModal');
        const content = document.getElementById('modalContent');
        const title = document.getElementById('modalTitle');
        const typeInput = document.getElementById('paymentTypeInput');
        const submitBtn = document.getElementById('submitBtn');

        // Reset classes
        modal.classList.remove('hidden');
        
        // Animation frame
        requestAnimationFrame(() => {
            content.classList.remove('translate-y-full', 'scale-95', 'opacity-0');
        });

        // Set Content based on type
        typeInput.value = type;
        if (type === 'send') {
            title.innerText = 'Record Payment (You Gave)';
            submitBtn.className = 'w-full py-3.5 rounded-xl text-white font-bold text-lg shadow-lg transition-transform active:scale-95 flex items-center justify-center gap-2 bg-red-600 hover:bg-red-700 shadow-red-500/30';
        } else {
            title.innerText = 'Record Receipt (You Received)';
            submitBtn.className = 'w-full py-3.5 rounded-xl text-white font-bold text-lg shadow-lg transition-transform active:scale-95 flex items-center justify-center gap-2 bg-green-600 hover:bg-green-700 shadow-green-500/30';
        }
    }

    function closePaymentModal() {
        const modal = document.getElementById('paymentModal');
        const content = document.getElementById('modalContent');

        content.classList.add('translate-y-full', 'scale-95', 'opacity-0');
        
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }
</script>
