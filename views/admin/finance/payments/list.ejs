<!-- Header -->
<div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
    <div>
        <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">Payments & Transactions</h1>
        <p class="text-gray-500 text-sm mt-1">Track your cash flow and pending settlements</p>
    </div>
    <a href="/admin/finance/payments/add" class="group relative inline-flex items-center justify-center px-6 py-3 text-sm font-bold text-white transition-all duration-200 bg-gradient-to-r from-teal-500 to-emerald-600 font-pj rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-600 hover:shadow-lg hover:from-teal-600 hover:to-emerald-700">
        <i class="fas fa-plus mr-2 transition-transform group-hover:rotate-90"></i> Record Transaction
    </a>
</div>

<!-- Summary Cards Grid -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Total Sent -->
    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 relative overflow-hidden group hover:shadow-md transition-all duration-300">
        <div class="absolute top-0 right-0 w-24 h-24 bg-red-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div>
        <div class="relative z-10">
            <div class="flex justify-between items-start mb-4">
                <div class="p-2 bg-red-50 rounded-lg text-red-600">
                    <i class="fas fa-arrow-up transform rotate-45 text-lg"></i>
                </div>
            </div>
            <p class="text-gray-500 text-sm font-medium uppercase tracking-wider">Total Sent</p>
            <h3 class="text-2xl font-bold text-gray-900 mt-1">Rs <%= dashboard.metrics.sent.toLocaleString() %></h3>
        </div>
        <div class="absolute bottom-0 left-0 w-full h-1 bg-red-500 transform scale-x-0 group-hover:scale-x-100 transition-transform duration-500 origin-left"></div>
    </div>

    <!-- Total Received -->
    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 relative overflow-hidden group hover:shadow-md transition-all duration-300">
        <div class="absolute top-0 right-0 w-24 h-24 bg-green-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div>
        <div class="relative z-10">
            <div class="flex justify-between items-start mb-4">
                <div class="p-2 bg-green-50 rounded-lg text-green-600">
                    <i class="fas fa-arrow-down transform rotate-45 text-lg"></i>
                </div>
            </div>
            <p class="text-gray-500 text-sm font-medium uppercase tracking-wider">Total Received</p>
            <h3 class="text-2xl font-bold text-gray-900 mt-1">Rs <%= dashboard.metrics.received.toLocaleString() %></h3>
        </div>
        <div class="absolute bottom-0 left-0 w-full h-1 bg-green-500 transform scale-x-0 group-hover:scale-x-100 transition-transform duration-500 origin-left"></div>
    </div>

    <!-- Net Balance -->
    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 relative overflow-hidden group hover:shadow-md transition-all duration-300">
        <div class="absolute top-0 right-0 w-24 h-24 <%= dashboard.metrics.net >= 0 ? 'bg-emerald-50' : 'bg-red-50' %> rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div>
        <div class="relative z-10">
            <div class="flex justify-between items-start mb-4">
                <div class="p-2 <%= dashboard.metrics.net >= 0 ? 'bg-emerald-50 text-emerald-600' : 'bg-red-50 text-red-600' %> rounded-lg">
                    <i class="fas fa-wallet text-lg"></i>
                </div>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <%= dashboard.metrics.net >= 0 ? 'bg-emerald-100 text-emerald-800' : 'bg-red-100 text-red-800' %>">
                    <%= dashboard.metrics.net >= 0 ? 'Profit' : 'Deficit' %>
                </span>
            </div>
            <p class="text-gray-500 text-sm font-medium uppercase tracking-wider">Net Balance</p>
            <h3 class="text-2xl font-bold <%= dashboard.metrics.net >= 0 ? 'text-emerald-600' : 'text-red-600' %> mt-1">
                <%= dashboard.metrics.net >= 0 ? '+' : '' %>Rs <%= dashboard.metrics.net.toLocaleString() %>
            </h3>
        </div>
        <div class="absolute bottom-0 left-0 w-full h-1 <%= dashboard.metrics.net >= 0 ? 'bg-emerald-500' : 'bg-red-500' %> transform scale-x-0 group-hover:scale-x-100 transition-transform duration-500 origin-left"></div>
    </div>

    <!-- Pending -->
    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 relative overflow-hidden group hover:shadow-md transition-all duration-300">
        <div class="absolute top-0 right-0 w-24 h-24 bg-orange-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div>
        <div class="relative z-10">
            <div class="flex justify-between items-start mb-4">
                <div class="p-2 bg-orange-50 rounded-lg text-orange-600">
                    <i class="fas fa-clock text-lg"></i>
                </div>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                    <%= dashboard.metrics.pending.count %> items
                </span>
            </div>
            <p class="text-gray-500 text-sm font-medium uppercase tracking-wider">Pending Amount</p>
            <h3 class="text-2xl font-bold text-gray-900 mt-1">Rs <%= dashboard.metrics.pending.amount.toLocaleString() %></h3>
        </div>
        <div class="absolute bottom-0 left-0 w-full h-1 bg-orange-500 transform scale-x-0 group-hover:scale-x-100 transition-transform duration-500 origin-left"></div>
    </div>
</div>

<!-- Cash Flow Chart -->
<div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-8">
    <div class="flex justify-between items-center mb-6">
        <h3 class="font-bold text-gray-800 flex items-center">
            <i class="fas fa-chart-line text-teal-500 mr-2"></i> Cash Flow â€“ Last 6 Months
        </h3>
        <div class="flex gap-4 text-sm">
            <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-green-500 mr-2"></span> Received</div>
            <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-red-500 mr-2"></span> Sent</div>
        </div>
    </div>
    <div class="h-72">
        <canvas id="cashFlowChart"></canvas>
    </div>
</div>

<!-- Top People (Horizontal Scroll) -->
<div class="mb-8">
    <h3 class="font-bold text-gray-800 mb-4 px-1">Top Contacts</h3>
    <div class="flex gap-4 overflow-x-auto pb-4 custom-scrollbar">
        <% dashboard.topPeople.forEach(person => { %>
            <div class="flex-shrink-0 w-64 bg-white rounded-xl p-4 shadow-sm border border-gray-100 hover:shadow-md transition-all cursor-pointer group">
                <div class="flex items-center mb-3">
                    <% if (person.avatar) { %>
                        <img src="<%= person.avatar %>" alt="<%= person.name %>" class="w-10 h-10 rounded-full object-cover mr-3 border-2 border-gray-100">
                    <% } else { %>
                        <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center mr-3 text-gray-500 font-bold border-2 border-gray-50">
                            <%= person.name.charAt(0).toUpperCase() %>
                        </div>
                    <% } %>
                    <div>
                        <h4 class="font-bold text-gray-900 text-sm truncate w-32"><%= person.name %></h4>
                        <p class="text-xs text-gray-500"><%= new Date(person.lastTransaction).toLocaleDateString() %></p>
                    </div>
                </div>
                <div class="flex justify-between items-end">
                    <div class="text-xs text-gray-500">Net Balance</div>
                    <div class="font-bold <%= person.net >= 0 ? 'text-green-600' : 'text-red-600' %>">
                        <%= person.net >= 0 ? '+' : '' %>Rs <%= person.net.toLocaleString() %>
                    </div>
                </div>
            </div>
        <% }) %>
    </div>
</div>

<!-- Transactions Table Section -->
<div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
    <!-- Toolbar -->
    <div class="p-5 border-b border-gray-100 flex flex-col sm:flex-row justify-between items-center gap-4 bg-gray-50/50">
        <div class="relative w-full sm:w-64">
            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            <input type="text" id="paymentSearch" placeholder="Search transactions..." class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent text-sm bg-white shadow-sm transition-all">
        </div>
        <div class="flex gap-2 w-full sm:w-auto">
            <select id="filterType" class="px-4 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-teal-500 bg-white shadow-sm cursor-pointer hover:border-teal-300 transition-colors">
                <option value="all">All Types</option>
                <option value="send">Sent</option>
                <option value="receive">Received</option>
            </select>
            <select id="filterStatus" class="px-4 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-teal-500 bg-white shadow-sm cursor-pointer hover:border-teal-300 transition-colors">
                <option value="all">All Status</option>
                <option value="Completed">Completed</option>
                <option value="Pending">Pending</option>
            </select>
        </div>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto">
        <table class="w-full text-left border-separate border-spacing-y-1 px-2">
            <thead class="bg-gray-50/50">
                <tr>
                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Date</th>
                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Person</th>
                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Type</th>
                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Amount</th>
                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Paid / Due</th>
                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider text-right">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y-0 divide-gray-200" id="paymentTableBody">
                <% if (payments.length === 0) { %>
                    <tr>
                        <td colspan="7" class="px-6 py-12 text-center">
                            <div class="flex flex-col items-center justify-center">
                                <div class="w-20 h-20 bg-teal-50 rounded-full flex items-center justify-center mb-4">
                                    <i class="fas fa-exchange-alt text-4xl text-teal-500"></i>
                                </div>
                                <h3 class="text-lg font-bold text-gray-900">No transactions yet</h3>
                                <p class="text-gray-500 text-sm mt-1">Record your first payment to start tracking.</p>
                            </div>
                        </td>
                    </tr>
                <% } else { %>
                    <% payments.forEach(payment => { %>
                        <tr class="group hover:bg-gray-50 transition-all duration-200 hover:shadow-sm rounded-lg bg-white" data-type="<%= payment.type %>" data-status="<%= payment.status %>">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 first:rounded-l-lg">
                                <div class="flex flex-col">
                                    <span class="font-bold text-gray-700"><%= new Date(payment.date).getDate() %></span>
                                    <span class="text-xs"><%= new Date(payment.date).toLocaleString('default', { month: 'short' }) %></span>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center mr-3 text-gray-500 group-hover:bg-white group-hover:shadow-sm transition-all">
                                        <% if (payment.person && payment.person.avatar) { %>
                                            <img src="<%= payment.person.avatar %>" class="w-full h-full rounded-full object-cover">
                                        <% } else { %>
                                            <span class="text-xs font-bold"><%= payment.person ? payment.person.name.charAt(0).toUpperCase() : '?' %></span>
                                        <% } %>
                                    </div>
                                    <span class="font-medium text-gray-900"><%= payment.person ? payment.person.name : 'Unknown' %></span>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <% if (payment.type === 'send') { %>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 border border-red-200">
                                        <i class="fas fa-arrow-up mr-1 text-[10px]"></i> Sent
                                    </span>
                                <% } else { %>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 border border-green-200">
                                        <i class="fas fa-arrow-down mr-1 text-[10px]"></i> Received
                                    </span>
                                <% } %>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="text-sm font-bold <%= payment.type === 'send' ? 'text-red-600' : 'text-green-600' %>">
                                    Rs <%= payment.amount.toLocaleString() %>
                                </span>
                            </td>
                            <td class="px-6 py-4 text-sm">
                                <% 
                                    const isPaid = payment.status === 'Completed';
                                    const percent = isPaid ? 100 : 0; 
                                %>
                                <div class="w-24">
                                    <div class="flex justify-between text-xs mb-1">
                                        <span class="<%= isPaid ? 'text-green-600' : 'text-orange-600' %> font-medium">
                                            <%= isPaid ? 'Paid' : 'Due' %>
                                        </span>
                                        <span class="text-gray-400"><%= percent %>%</span>
                                    </div>
                                    <div class="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden">
                                        <div class="<%= isPaid ? 'bg-green-500' : 'bg-orange-500' %> h-1.5 rounded-full transition-all duration-500" style="width: <%= percent %>%"></div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <% if(payment.status === 'Completed') { %>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        <span class="w-1.5 h-1.5 bg-green-500 rounded-full mr-1.5"></span> Completed
                                    </span>
                                <% } else { %>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                        <span class="w-1.5 h-1.5 bg-yellow-500 rounded-full mr-1.5"></span> Pending
                                    </span>
                                <% } %>
                            </td>
                            <td class="px-6 py-4 text-right text-sm font-medium last:rounded-r-lg">
                                <div class="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-all duration-200 transform translate-x-2 group-hover:translate-x-0">
                                    <a href="/admin/finance/payments/edit/<%= payment._id %>" class="text-gray-400 hover:text-indigo-600 transition-colors p-1" title="Edit">
                                        <i class="fas fa-pen"></i>
                                    </a>
                                    <a href="/admin/finance/payments/delete/<%= payment._id %>" class="text-gray-400 hover:text-red-600 transition-colors p-1" onclick="return confirm('Are you sure?')" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    <% }) %>
                <% } %>
            </tbody>
        </table>
    </div>
</div>

<!-- Floating Action Buttons -->
<div class="fixed bottom-8 right-8 flex flex-col gap-4 z-50">
    <a href="/admin/finance/payments/add?type=receive" class="w-12 h-12 bg-green-500 rounded-full shadow-lg flex items-center justify-center text-white hover:shadow-xl hover:scale-110 transition-all duration-300" title="Receive Money">
        <i class="fas fa-arrow-down"></i>
    </a>
    <a href="/admin/finance/payments/add?type=send" class="w-14 h-14 bg-red-500 rounded-full shadow-lg flex items-center justify-center text-white hover:shadow-xl hover:scale-110 transition-all duration-300" title="Send Money">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Data from Server
        const cashFlowData = <%- JSON.stringify(dashboard.charts.cashFlow) %>;

        // Cash Flow Chart
        const ctx = document.getElementById('cashFlowChart').getContext('2d');
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: cashFlowData.labels,
                datasets: [
                    {
                        label: 'Received',
                        data: cashFlowData.received,
                        borderColor: '#22c55e', // Green
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        borderWidth: 3,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: '#22c55e',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Sent',
                        data: cashFlowData.sent,
                        borderColor: '#ef4444', // Red
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        borderWidth: 3,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: '#ef4444',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#1e293b',
                        padding: 12,
                        titleFont: { size: 13 },
                        bodyFont: { size: 14, weight: 'bold' },
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': Rs ' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { borderDash: [4, 4], color: '#f1f5f9' },
                        ticks: { font: { size: 11 }, color: '#94a3b8' }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { font: { size: 11 }, color: '#94a3b8' }
                    }
                }
            }
        });

        // Search & Filter Logic
        const searchInput = document.getElementById('paymentSearch');
        const filterType = document.getElementById('filterType');
        const filterStatus = document.getElementById('filterStatus');
        const tableRows = document.querySelectorAll('#paymentTableBody tr');

        function filterTable() {
            const term = searchInput.value.toLowerCase();
            const type = filterType.value;
            const status = filterStatus.value;

            tableRows.forEach(row => {
                const text = row.innerText.toLowerCase();
                const rowType = row.getAttribute('data-type');
                const rowStatus = row.getAttribute('data-status');

                const matchesSearch = text.includes(term);
                const matchesType = type === 'all' || rowType === type;
                const matchesStatus = status === 'all' || rowStatus === status;

                row.style.display = (matchesSearch && matchesType && matchesStatus) ? '' : 'none';
            });
        }

        searchInput.addEventListener('keyup', filterTable);
        filterType.addEventListener('change', filterTable);
        filterStatus.addEventListener('change', filterTable);
    });
</script>
