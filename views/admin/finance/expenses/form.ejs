<div class="max-w-2xl mx-auto">
    <div class="bg-white rounded-xl shadow-sm p-8 border border-gray-100">
        <h2 class="text-2xl font-bold mb-6 text-gray-800"><%= expense._id ? 'Edit Expense' : 'Add New Expense' %></h2>
        
        <form action="<%= expense._id ? '/admin/finance/expenses/edit/' + expense._id : '/admin/finance/expenses/add' %>" method="POST" class="space-y-6 offline-form">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Title / Description</label>
                <input type="text" name="title" value="<%= expense.title || '' %>" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Amount</label>
                    <div class="relative">
                        <span class="absolute left-4 top-2 text-gray-500">Rs.</span>
                        <input type="number" name="amount" value="<%= expense.amount || '' %>" required min="0" class="w-full pl-12 px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                    <input type="date" name="date" value="<%= expense.date ? new Date(expense.date).toISOString().split('T')[0] : new Date().toISOString().split('T')[0] %>" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">End Date (Due Date)</label>
                    <input type="date" name="endDate" value="<%= expense.endDate ? new Date(expense.endDate).toISOString().split('T')[0] : '' %>" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                    <select name="category" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select Category</option>
                        <% categories.forEach(c => { %>
                            <option value="<%= c.name %>" <%= expense.category === c.name ? 'selected' : '' %>><%= c.name %></option>
                        <% }) %>
                        <!-- Fallback for old categories or custom ones -->
                        <% if(expense.category && !categories.find(c => c.name === expense.category)) { %>
                            <option value="<%= expense.category %>" selected><%= expense.category %></option>
                        <% } %>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Paid From Wallet</label>
                    <select name="wallet" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select Wallet</option>
                        <% wallets.forEach(w => { %>
                            <option value="<%= w._id %>" <%= (expense.wallet && expense.wallet.toString() === w._id.toString()) ? 'selected' : '' %>><%= w.name %> (<%= w.currency %> <%= w.balance %>)</option>
                        <% }) %>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                    <select name="status" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="Paid" <%= expense.status === 'Paid' ? 'selected' : '' %>>Paid</option>
                        <option value="Pending" <%= expense.status === 'Pending' ? 'selected' : '' %>>Pending</option>
                        <option value="Partial" <%= expense.status === 'Partial' ? 'selected' : '' %>>Partial</option>
                        <option value="Overdue" <%= expense.status === 'Overdue' ? 'selected' : '' %>>Overdue</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Paid Amount</label>
                    <input type="number" name="paidAmount" value="<%= expense.paidAmount !== undefined ? expense.paidAmount : (expense.amount || '') %>" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <% if (expense.amount && expense.paidAmount !== undefined) { %>
                        <p class="text-sm text-red-500 mt-1">Due: Rs <%= (expense.amount - expense.paidAmount).toLocaleString() %></p>
                    <% } %>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Notes (Optional)</label>
                <textarea name="notes" rows="3" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"><%= expense.notes || '' %></textarea>
            </div>

            <div class="flex justify-end space-x-4 pt-4">
                <a href="/admin/finance/expenses" class="px-6 py-2.5 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 font-medium">Cancel</a>
                <button type="submit" class="px-6 py-2.5 rounded-lg bg-blue-600 text-white hover:bg-blue-700 font-medium shadow-lg shadow-blue-500/30">Save Expense</button>
            </div>
        </form>
    </div>
</div>
